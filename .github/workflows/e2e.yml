# e2e.yml — Full end-to-end integration tests.
# Builds all Docker images, starts the platform via Docker Compose,
# runs smoke tests, captures traces, and uploads a CI report.
name: E2E

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    name: End-to-end integration tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Build Docker images individually (matches working Build workflow)
      # -----------------------------------------------------------------------
      - name: Build registry image
        run: |
          docker build --progress=plain -t docker-registry services/registry 2>&1 | tee /tmp/build-registry.log || {
            echo "### Registry build failed" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -50 /tmp/build-registry.log >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            exit 1
          }
        env:
          DOCKER_BUILDKIT: "1"

      - name: Build builder image
        run: docker build --progress=plain -t docker-builder services/builder
        env:
          DOCKER_BUILDKIT: "1"

      - name: Build operator image
        run: docker build --progress=plain -t docker-operator services/operator
        env:
          DOCKER_BUILDKIT: "1"

      - name: Build envmanager image
        run: docker build --progress=plain -t docker-envmanager services/envmanager
        env:
          DOCKER_BUILDKIT: "1"

      - name: Build gateway image
        run: |
          docker build --progress=plain -t docker-gateway services/gateway 2>&1 | tee /tmp/build-gateway.log || {
            echo "### Gateway build failed" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -80 /tmp/build-gateway.log >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            exit 1
          }
        env:
          DOCKER_BUILDKIT: "1"

      - name: Build console image
        run: docker build --progress=plain -t docker-console ui/console
        env:
          DOCKER_BUILDKIT: "1"

      - name: Verify images and compose config
        run: |
          echo "### Docker Images" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | head -20 | tee -a "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Compose Config (images)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          docker compose -f infra/docker/docker-compose.yml config --images 2>&1 | tee -a "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Pull infra images
        run: docker compose -f infra/docker/docker-compose.yml pull --ignore-buildable

      - name: Start platform
        run: docker compose -f infra/docker/docker-compose.yml up -d --no-build

      - name: Wait for services to be healthy
        run: ./hack/scripts/wait-for-healthy.sh 180
        env:
          HEALTH_TIMEOUT: "180"

      # -----------------------------------------------------------------------
      # Diagnostics on failure (always capture container state)
      # -----------------------------------------------------------------------
      - name: Container diagnostics
        if: failure()
        run: |
          # Write diagnostics to file (uploaded as artifact) AND use annotations (readable via API)
          DIAG_FILE="${GITHUB_WORKSPACE}/ci-report/diagnostics.txt"
          mkdir -p "${GITHUB_WORKSPACE}/ci-report"

          echo "=== CONTAINER STATUS ===" | tee "$DIAG_FILE"
          docker compose -f infra/docker/docker-compose.yml ps -a 2>&1 | tee -a "$DIAG_FILE" || true
          echo "" | tee -a "$DIAG_FILE"

          echo "=== PORT CONNECTIVITY ===" | tee -a "$DIAG_FILE"
          for port in 8080 8081 8082 8083 8084 3000; do
            code=$(curl -s -o /dev/null -w '%{http_code}' "http://localhost:${port}/healthz" 2>/dev/null || echo "000")
            echo "  Port $port: HTTP $code" | tee -a "$DIAG_FILE"
          done
          echo "" | tee -a "$DIAG_FILE"

          echo "=== SERVICE LOGS ===" | tee -a "$DIAG_FILE"
          for svc in otel-collector registry builder operator envmanager gateway console; do
            echo "--- $svc ---" | tee -a "$DIAG_FILE"
            docker compose -f infra/docker/docker-compose.yml logs --tail=20 --no-color "$svc" 2>&1 | tee -a "$DIAG_FILE" || echo "(no logs)" | tee -a "$DIAG_FILE"
          done

          # Emit key diagnostics as annotations (accessible via API)
          CONTAINER_STATUS=$(docker compose -f infra/docker/docker-compose.yml ps -a 2>&1 | head -15 || true)
          echo "::warning title=Container Status::${CONTAINER_STATUS//$'\n'/%0A}"

          PORT_STATUS=""
          for port in 8080 8081 8082 8083 8084 3000; do
            code=$(curl -s -o /dev/null -w '%{http_code}' "http://localhost:${port}/healthz" 2>/dev/null || echo "000")
            PORT_STATUS="${PORT_STATUS}Port ${port}: HTTP ${code}%0A"
          done
          echo "::warning title=Port Connectivity::${PORT_STATUS}"

      # -----------------------------------------------------------------------
      # Run smoke tests
      # -----------------------------------------------------------------------
      - name: Run smoke tests
        id: smoke
        run: ./hack/scripts/run-smoke-tests.sh

      # -----------------------------------------------------------------------
      # Capture observability data (always, even if smoke tests fail)
      # -----------------------------------------------------------------------
      - name: Capture traces
        if: always()
        run: ./hack/scripts/capture-traces.sh
        env:
          LOOKBACK_MINUTES: "10"

      - name: Capture screenshots
        if: always()
        run: ./hack/scripts/capture-screenshots.sh

      # -----------------------------------------------------------------------
      # Generate the CI report
      # -----------------------------------------------------------------------
      - name: Generate CI report
        if: always()
        run: ./hack/scripts/dump-ci-report.sh

      - name: Print CI report
        if: always()
        run: cat ci-report/REPORT.md

      # -----------------------------------------------------------------------
      # Dump logs on failure for debugging
      # -----------------------------------------------------------------------
      - name: Dump service logs on failure
        if: failure()
        run: docker compose -f infra/docker/docker-compose.yml logs --no-color --tail=500

      # -----------------------------------------------------------------------
      # Upload artifacts
      # -----------------------------------------------------------------------
      - name: Upload CI report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-report
          path: ci-report/
          retention-days: 14

      # -----------------------------------------------------------------------
      # Post summary to PR
      # -----------------------------------------------------------------------
      - name: Post smoke test summary
        if: always()
        run: |
          if [ -f ci-report/smoke-results.json ]; then
            total=$(grep -o '"total":\s*[0-9]*' ci-report/smoke-results.json | grep -o '[0-9]*' || echo "?")
            passed=$(grep -o '"passed":\s*[0-9]*' ci-report/smoke-results.json | grep -o '[0-9]*' || echo "?")
            failed=$(grep -o '"failed":\s*[0-9]*' ci-report/smoke-results.json | grep -o '[0-9]*' || echo "?")

            if [ "$failed" = "0" ]; then
              echo "### E2E Smoke Tests: All ${total} passed" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "### E2E Smoke Tests: ${failed} failed (${passed}/${total} passed)" >> "$GITHUB_STEP_SUMMARY"
            fi

            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "| Test | Status | Duration |" >> "$GITHUB_STEP_SUMMARY"
            echo "|------|--------|----------|" >> "$GITHUB_STEP_SUMMARY"

            # Parse each test result from the JSON
            while IFS= read -r line; do
              name=$(echo "$line" | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
              status=$(echo "$line" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              duration=$(echo "$line" | grep -o '"duration_ms":[0-9]*' | cut -d: -f2)
              if [ -n "$name" ]; then
                icon="✅"
                [ "$status" = "fail" ] && icon="❌"
                echo "| ${name} | ${icon} ${status} | ${duration:-0}ms |" >> "$GITHUB_STEP_SUMMARY"
              fi
            done < <(grep -o '{[^}]*}' ci-report/smoke-results.json | grep '"name"')
          else
            echo "### E2E Smoke Tests: No results (tests may not have run)" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Full CI report available in the **ci-report** artifact." >> "$GITHUB_STEP_SUMMARY"

      # -----------------------------------------------------------------------
      # Teardown
      # -----------------------------------------------------------------------
      - name: Stop platform
        if: always()
        run: docker compose -f infra/docker/docker-compose.yml down -v
