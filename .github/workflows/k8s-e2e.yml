# Kubernetes end-to-end tests.
# Deploys the full platform into a kind cluster, publishes packages, and
# verifies the operator creates the expected K8s resources.
name: K8s E2E

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: k8s-e2e-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  k8s-e2e:
    name: Kubernetes end-to-end tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # Set up Docker Buildx with GHA layer cache
      # ---------------------------------------------------------------
      - uses: docker/setup-buildx-action@v3

      # ---------------------------------------------------------------
      # Build Docker images (cached across runs via GHA cache)
      # Builds are batched to limit peak memory usage.
      # ---------------------------------------------------------------
      - name: Build Go service images
        run: TAG=e2e CACHE=gha docker buildx bake --progress=plain --load go-services

      - name: Build gateway image (Rust)
        run: TAG=e2e CACHE=gha docker buildx bake --progress=plain --load gateway

      - name: Build console, explorer + E2E fixture images
        run: TAG=e2e CACHE=gha docker buildx bake --progress=plain --load console explorer e2e-fixtures

      # ---------------------------------------------------------------
      # Verify images
      # ---------------------------------------------------------------
      - name: Verify images
        run: |
          IMAGES=$(docker images 'turbo-engine/*' --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}")
          echo "$IMAGES"
          echo "::warning title=Docker Images::${IMAGES//$'\n'/%0A}"
          for svc in registry builder operator envmanager gateway console explorer petstore-mock orchestrator; do
            docker image inspect "turbo-engine/${svc}:e2e" > /dev/null 2>&1 || {
              echo "::error::Missing image turbo-engine/${svc}:e2e"
              exit 1
            }
          done

      # ---------------------------------------------------------------
      # Create kind cluster
      # ---------------------------------------------------------------
      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: turbo-engine-e2e

      # ---------------------------------------------------------------
      # Load images into kind
      # ---------------------------------------------------------------
      - name: Load images into kind
        run: |
          for svc in registry builder envmanager operator gateway console explorer petstore-mock orchestrator; do
            echo "Loading turbo-engine/${svc}:e2e..."
            kind load docker-image "turbo-engine/${svc}:e2e" --name turbo-engine-e2e
          done

      - name: Verify images in kind
        run: |
          docker exec turbo-engine-e2e-control-plane crictl images | grep turbo-engine || true

      # ---------------------------------------------------------------
      # Deploy CRD + control plane + telemetry
      # ---------------------------------------------------------------
      - name: Create namespace
        run: kubectl create namespace turbo-engine-e2e || true

      - name: Deploy platform to kind
        run: |
          kubectl apply -k infra/k8s/overlays/ci
          echo ""
          echo "Waiting for deployments to roll out..."
          kubectl -n turbo-engine-e2e rollout status deployment --timeout=180s

      - name: Deployment diagnostics
        if: failure()
        run: |
          mkdir -p ci-report/k8s

          echo "=== POD STATUS ==="
          kubectl get pods -n turbo-engine-e2e -o wide 2>&1 | tee ci-report/k8s-diagnostics.txt

          echo ""
          echo "=== EVENTS ==="
          kubectl get events -n turbo-engine-e2e --sort-by=.lastTimestamp 2>&1 | tee -a ci-report/k8s-diagnostics.txt

          echo ""
          echo "=== DESCRIBE FAILING PODS ==="
          kubectl describe pods -n turbo-engine-e2e 2>&1 | tee -a ci-report/k8s-diagnostics.txt

          POD_STATUS=$(kubectl get pods -n turbo-engine-e2e -o wide 2>&1 | head -15)
          echo "::warning title=K8s Pod Status::${POD_STATUS//$'\n'/%0A}"

      # ---------------------------------------------------------------
      # Run E2E tests
      # ---------------------------------------------------------------
      - name: Run K8s E2E tests
        run: ./hack/scripts/k8s-e2e-tests.sh

      # ---------------------------------------------------------------
      # Collect debug artifacts (always)
      # ---------------------------------------------------------------
      - name: Collect debug info
        if: always()
        run: ./hack/scripts/k8s-collect-debug.sh

      - name: Cache Playwright browsers
        if: always()
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}

      - name: Capture screenshots
        if: always()
        run: |
          # Install Playwright npm package + Chromium browser.
          # Use --prefix to install into a known location independent of workspace.
          npm install --prefix /tmp/pw playwright 2>&1 | tail -10
          echo "Playwright npm package installed"
          NODE_PATH=/tmp/pw/node_modules npx --prefix /tmp/pw playwright install --with-deps chromium 2>&1 | tail -10
          echo "Playwright browsers installed"

          # Port-forward UI frontends
          kubectl -n turbo-engine-e2e port-forward svc/console 13000:3000 &>/dev/null &
          PF_CONSOLE=$!
          kubectl -n turbo-engine-e2e port-forward svc/explorer 13001:3001 &>/dev/null &
          PF_EXPLORER=$!

          # Port-forward backend services so Playwright can proxy API calls.
          # The UIs use /api/registry/*, /api/builder/*, etc. (Vite proxy in dev),
          # but in K8s the SPA static server returns index.html for unknown paths.
          # capture-screenshots.sh intercepts these requests via page.route().
          kubectl -n turbo-engine-e2e port-forward svc/registry 18081:8081 &>/dev/null &
          PF_REGISTRY=$!
          kubectl -n turbo-engine-e2e port-forward svc/builder 18082:8082 &>/dev/null &
          PF_BUILDER=$!
          kubectl -n turbo-engine-e2e port-forward svc/envmanager 18083:8083 &>/dev/null &
          PF_ENVMANAGER=$!
          kubectl -n turbo-engine-e2e port-forward svc/gateway 18080:8080 &>/dev/null &
          PF_GATEWAY=$!
          kubectl -n turbo-engine-e2e port-forward svc/jaeger 18686:16686 &>/dev/null &
          PF_JAEGER=$!
          sleep 3

          NODE_PATH=/tmp/pw/node_modules \
            CONSOLE_URL=http://localhost:13000 \
            EXPLORER_URL=http://localhost:13001 \
            REGISTRY_URL=http://localhost:18081 \
            BUILDER_URL=http://localhost:18082 \
            ENVMANAGER_URL=http://localhost:18083 \
            GATEWAY_URL=http://localhost:18080 \
            JAEGER_URL=http://localhost:18686 \
            ./hack/scripts/capture-screenshots.sh || true

          kill $PF_CONSOLE $PF_EXPLORER $PF_REGISTRY $PF_BUILDER $PF_ENVMANAGER $PF_GATEWAY $PF_JAEGER 2>/dev/null || true

      - name: Capture traces and generate report
        if: always()
        run: |
          # Port-forward Jaeger for trace capture.
          # Screenshots are already captured above, so the report includes them.
          kubectl -n turbo-engine-e2e port-forward svc/jaeger 16686:16686 &>/dev/null &
          PF_PID=$!
          sleep 3
          JAEGER_PORT=16686 ./hack/scripts/k8s-dump-report.sh || true
          kill $PF_PID 2>/dev/null || true

      # ---------------------------------------------------------------
      # Upload artifacts
      # ---------------------------------------------------------------
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k8s-e2e-report
          path: ci-report/
          retention-days: 14

      # ---------------------------------------------------------------
      # Publish report to ci-reports branch (for GitHub Pages + Claude)
      # ---------------------------------------------------------------
      - name: Publish report to ci-reports branch
        id: publish_report
        if: always()
        env:
          REPORT_TYPE: k8s-e2e
          PR_NUMBER: ${{ github.event.pull_request.number || 'push' }}
          RUN_NUMBER: ${{ github.run_number }}
          RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          ./hack/scripts/publish-ci-report.sh || echo "::error title=Report Publish::publish-ci-report.sh exited with code $?"

      # ---------------------------------------------------------------
      # Summary + PR comment
      # ---------------------------------------------------------------
      - name: Build K8s E2E summary
        id: summary
        if: always()
        run: |
          SUMMARY_FILE=$(mktemp)

          if [ -f ci-report/k8s-e2e-results.json ]; then
            total=$(grep -o '"total":\s*[0-9]*' ci-report/k8s-e2e-results.json | grep -o '[0-9]*' || echo "?")
            passed=$(grep -o '"passed":\s*[0-9]*' ci-report/k8s-e2e-results.json | grep -o '[0-9]*' || echo "?")
            failed=$(grep -o '"failed":\s*[0-9]*' ci-report/k8s-e2e-results.json | grep -o '[0-9]*' || echo "?")

            if [ "$failed" = "0" ]; then
              echo "### K8s E2E: All ${total} tests passed" >> "$SUMMARY_FILE"
            else
              echo "### K8s E2E: ${failed} failed (${passed}/${total} passed)" >> "$SUMMARY_FILE"
            fi

            echo "" >> "$SUMMARY_FILE"
            echo "| Test | Status | Detail | Duration |" >> "$SUMMARY_FILE"
            echo "|------|--------|--------|----------|" >> "$SUMMARY_FILE"

            while IFS= read -r line; do
              name=$(echo "$line" | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
              status=$(echo "$line" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
              detail=$(echo "$line" | grep -o '"detail":"[^"]*"' | cut -d'"' -f4)
              duration=$(echo "$line" | grep -o '"duration_ms":[0-9]*' | cut -d: -f2)
              if [ -n "$name" ]; then
                icon="PASS"
                [ "$status" = "fail" ] && icon="FAIL"
                echo "| \`${name}\` | ${icon} | ${detail} | ${duration:-0}ms |" >> "$SUMMARY_FILE"
              fi
            done < <(grep -o '{[^}]*}' ci-report/k8s-e2e-results.json | grep '"name"')
          else
            echo "### K8s E2E: No results" >> "$SUMMARY_FILE"
            echo "Tests may not have run. Check deployment diagnostics." >> "$SUMMARY_FILE"
          fi

          # K8s resource state
          if [ -f ci-report/k8s/resources.txt ]; then
            echo "" >> "$SUMMARY_FILE"
            echo "<details><summary>K8s resource state</summary>" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo '```' >> "$SUMMARY_FILE"
            head -50 ci-report/k8s/resources.txt >> "$SUMMARY_FILE"
            echo '```' >> "$SUMMARY_FILE"
            echo "</details>" >> "$SUMMARY_FILE"
          fi

          # Timeline
          if [ -f ci-report/k8s/timeline.txt ]; then
            echo "" >> "$SUMMARY_FILE"
            echo "<details><summary>Timeline</summary>" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo '```' >> "$SUMMARY_FILE"
            cat ci-report/k8s/timeline.txt >> "$SUMMARY_FILE"
            echo '```' >> "$SUMMARY_FILE"
            echo "</details>" >> "$SUMMARY_FILE"
          fi

          echo "" >> "$SUMMARY_FILE"
          REPORT_URL="${{ steps.publish_report.outputs.report_url }}"
          if [ -n "$REPORT_URL" ]; then
            echo "Full report: [**Browse on GitHub Pages**](${REPORT_URL}) | [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> "$SUMMARY_FILE"
          else
            echo "Full debug output in the [**k8s-e2e-report** artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> "$SUMMARY_FILE"
          fi

          cat "$SUMMARY_FILE" >> "$GITHUB_STEP_SUMMARY"
          echo "file=${SUMMARY_FILE}" >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPO: ${{ github.repository }}
          REPORT_URL: ${{ steps.publish_report.outputs.report_url }}
        run: |
          SUMMARY_FILE="${{ steps.summary.outputs.file }}"
          if [ ! -f "$SUMMARY_FILE" ]; then exit 0; fi

          MARKER="<!-- turbo-engine-k8s-e2e-bot -->"
          {
            echo "$MARKER"
            cat "$SUMMARY_FILE"
            echo ""
            echo "---"
            if [ -n "$REPORT_URL" ]; then
              echo "**[View full report with screenshots](${REPORT_URL})** | [workflow run](${RUN_URL})"
            else
              echo "*Posted by the K8s E2E workflow â€” [view run](${RUN_URL})*"
            fi
          } > /tmp/pr-comment-body.txt

          EXISTING_COMMENT_ID=$(gh api \
            "repos/${REPO}/issues/${PR_NUMBER}/comments" \
            --paginate --jq ".[] | select(.body | startswith(\"${MARKER}\")) | .id" \
            | head -1 || true)

          if [ -n "$EXISTING_COMMENT_ID" ]; then
            gh api "repos/${REPO}/issues/comments/${EXISTING_COMMENT_ID}" \
              -X PATCH -F body=@/tmp/pr-comment-body.txt
          else
            gh pr comment "$PR_NUMBER" --body-file /tmp/pr-comment-body.txt
          fi

      # ---------------------------------------------------------------
      # Cleanup
      # ---------------------------------------------------------------
      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name turbo-engine-e2e
