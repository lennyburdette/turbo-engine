# build.yml — Verify all service binaries and Docker images build successfully.
# Catches compilation errors across the polyglot stack without running the
# full E2E suite.
name: Build

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.23"
  RUST_VERSION: "1.93"
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # ---------------------------------------------------------------------------
  # Go binaries
  # ---------------------------------------------------------------------------
  go-build:
    name: Build Go services
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [registry, builder, operator, envmanager]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: services/${{ matrix.service }}/go.sum

      - name: Build ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        run: CGO_ENABLED=0 go build -ldflags="-s -w" -o /dev/null ./cmd/${{ matrix.service }}

  # ---------------------------------------------------------------------------
  # Rust binary
  # ---------------------------------------------------------------------------
  rust-build:
    name: Build gateway (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y pkg-config libssl-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: services/gateway

      - name: Build gateway
        working-directory: services/gateway
        run: cargo build --release

  # ---------------------------------------------------------------------------
  # TypeScript packages
  # ---------------------------------------------------------------------------
  ts-build:
    name: Build TypeScript packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm -r build

  # ---------------------------------------------------------------------------
  # Docker images — verify Dockerfiles are valid
  # ---------------------------------------------------------------------------
  docker-build:
    name: Build Docker images
    runs-on: ubuntu-latest
    needs: [go-build, rust-build, ts-build]
    steps:
      - uses: actions/checkout@v4

      - name: Build all Docker images
        run: docker compose -f infra/docker/docker-compose.yml build
        env:
          DOCKER_BUILDKIT: "1"
          COMPOSE_DOCKER_CLI_BUILD: "1"
