#!/usr/bin/env bash
# k8s-dump-report.sh — Generates ci-report/REPORT.md (top-level index) and
# captures Jaeger traces.  Per-scenario reports are generated by the scenario
# runner (k8s-run-scenario.py).
#
# Prerequisites: Run k8s-e2e-tests.sh and k8s-collect-debug.sh first.
#
# Output: ci-report/REPORT.md
set -uo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd)"
REPORT_DIR="${ROOT_DIR}/ci-report"
K8S_DIR="${REPORT_DIR}/k8s"
REPORT_FILE="${REPORT_DIR}/REPORT.md"

RESULTS_FILE="${REPORT_DIR}/k8s-e2e-results.json"
TIMELINE_FILE="${K8S_DIR}/timeline.txt"
TRACES_FILE="${REPORT_DIR}/traces.json"

JAEGER_PORT="${JAEGER_PORT:-16686}"

mkdir -p "${REPORT_DIR}" "${K8S_DIR}"

CYAN='\033[0;36m'
GREEN='\033[0;32m'
RESET='\033[0m'

info()  { printf "${CYAN}[INFO]${RESET}  %s\n" "$*" >&2; }
ok()    { printf "${GREEN}[OK]${RESET}    %s\n" "$*" >&2; }

# ---------------------------------------------------------------------------
# Capture traces from Jaeger (if port-forwarded)
# ---------------------------------------------------------------------------
info "Attempting to capture traces from Jaeger..."

JAEGER_URL="http://localhost:${JAEGER_PORT}"
jaeger_status=$(curl -s -o /dev/null -w '%{http_code}' "${JAEGER_URL}/" 2>/dev/null || echo "000")

if [[ "$jaeger_status" == "200" ]]; then
  NOW_US=$(( $(date +%s) * 1000000 ))
  START_US=$(( NOW_US - (10 * 60 * 1000000) ))

  {
    printf '{\n'
    printf '  "captured_at": "%s",\n' "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
    printf '  "services": {\n'

    first=true
    for svc in registry builder envmanager operator gateway orchestrator petstore-mock; do
      if ! $first; then printf ',\n'; fi
      first=false

      trace_data=$(curl -s "${JAEGER_URL}/api/traces?service=${svc}&start=${START_US}&end=${NOW_US}&limit=50&lookback=custom" 2>/dev/null || echo '{"data":[]}')
      printf '    "%s": %s' "$svc" "$trace_data"
    done

    printf '\n  }\n'
    printf '}\n'
  } > "${TRACES_FILE}"

  ok "Traces captured to traces.json"
else
  info "Jaeger not reachable (HTTP ${jaeger_status}) — skipping trace capture"
fi

# Generate trace viewer HTML + text summary.
TRACE_VIEWER="${SCRIPT_DIR}/generate-trace-viewer.sh"
if [[ -f "$TRACE_VIEWER" && -f "$TRACES_FILE" ]]; then
  info "Generating trace viewer..."
  bash "$TRACE_VIEWER" || true
fi

# ---------------------------------------------------------------------------
# Build the top-level report
# ---------------------------------------------------------------------------
info "Generating report: ${REPORT_FILE}"

exec 3>&1
exec > "${REPORT_FILE}"

cat <<'HEADER'
# K8s E2E Report

HEADER

printf "**Generated:** %s\n\n" "$(date -u +%Y-%m-%dT%H:%M:%SZ)"

# --- Result banner --------------------------------------------------------
if [[ -f "$RESULTS_FILE" ]]; then
  total=$(grep -o '"total":\s*[0-9]*' "$RESULTS_FILE" | grep -o '[0-9]*' || echo "0")
  passed=$(grep -o '"passed":\s*[0-9]*' "$RESULTS_FILE" | grep -o '[0-9]*' || echo "0")
  failed=$(grep -o '"failed":\s*[0-9]*' "$RESULTS_FILE" | grep -o '[0-9]*' || echo "0")

  if [[ "$failed" == "0" ]]; then
    printf "**ALL %s TESTS PASSED**\n\n" "$total"
  else
    printf "**%s FAILED** (%s/%s passed)\n\n" "$failed" "$passed" "$total"
  fi
fi

# --- Timeline (compact) ---------------------------------------------------
if [[ -f "$TIMELINE_FILE" ]]; then
  printf '```\n'
  cat "$TIMELINE_FILE"
  printf '```\n\n'
fi

# --- Per-scenario summaries -----------------------------------------------
printf "## Scenarios\n\n"

# List scenario reports and link to them.
SCENARIO_DIR="${REPORT_DIR}/scenarios"
if [[ -d "$SCENARIO_DIR" ]]; then
  for scenario_report in "${SCENARIO_DIR}"/*/report.md; do
    [[ -f "$scenario_report" ]] || continue
    scenario_name=$(basename "$(dirname "$scenario_report")")

    # Extract the first line (the banner) for a quick summary.
    banner=$(head -1 "$scenario_report" | sed 's/^# //')

    # Count screenshots.
    ss_dir="${REPORT_DIR}/screenshots/${scenario_name}"
    ss_count=0
    if [[ -d "$ss_dir" ]]; then
      ss_count=$(find "$ss_dir" -name '*.png' 2>/dev/null | wc -l)
    fi

    printf "### [%s](./scenarios/%s/report.md)\n\n" "$banner" "$scenario_name"
    printf "%s screenshots" "$ss_count"
    if [[ -f "${REPORT_DIR}/traces.html" ]]; then
      printf " | [traces](./traces.html)"
    fi
    printf "\n\n"
  done
else
  echo "_No scenario reports found._"
  echo ""
fi

# --- Platform health (compact) --------------------------------------------
printf "## Platform Health\n\n"

if [[ -f "${K8S_DIR}/resources.txt" ]]; then
  # Extract just pod status lines (compact view).
  running=$(grep -c 'Running' "${K8S_DIR}/resources.txt" 2>/dev/null || echo "0")
  total_pods=$(grep -c '^pod/' "${K8S_DIR}/resources.txt" 2>/dev/null || echo "0")

  printf "**Pods:** %s/%s running\n\n" "$running" "$total_pods"

  # Show non-Running pods if any exist.
  non_running=$(grep '^pod/' "${K8S_DIR}/resources.txt" | grep -v 'Running' || true)
  if [[ -n "$non_running" ]]; then
    printf "**Non-running pods:**\n\`\`\`\n%s\n\`\`\`\n\n" "$non_running"
  fi

  printf "<details><summary>Full resource list</summary>\n\n"
  printf '```\n'
  cat "${K8S_DIR}/resources.txt"
  printf '```\n\n'
  printf "</details>\n\n"
fi

# --- Errors (only if found) -----------------------------------------------
SERVICES=(registry builder envmanager turbo-engine-operator gateway)
ERRORS_FOUND=false
ERROR_OUTPUT=""

for svc in "${SERVICES[@]}"; do
  LOG_FILE="${K8S_DIR}/logs-${svc}.txt"
  if [[ -f "$LOG_FILE" ]]; then
    errors=$(grep -iE '("level":"ERROR"|"level":"error"|panic|fatal)' "$LOG_FILE" \
      | grep -v 'failed to initialise OTLP' \
      | grep -v 'failed to initialize tracer' \
      | tail -5 || true)

    if [[ -n "$errors" ]]; then
      ERRORS_FOUND=true
      ERROR_OUTPUT+="**${svc}:**"$'\n'
      ERROR_OUTPUT+='```'$'\n'"${errors}"$'\n''```'$'\n\n'
    fi
  fi
done

if $ERRORS_FOUND; then
  printf "## Errors\n\n"
  printf "%s" "$ERROR_OUTPUT"
fi

# --- Trace summary (compact) ---------------------------------------------
if [[ -f "$TRACES_FILE" ]]; then
  printf "## Traces\n\n"

  trace_summary=""
  for svc in registry builder envmanager operator gateway orchestrator petstore-mock; do
    count=$(python3 -c "
import json
data = json.load(open('${TRACES_FILE}'))
svc_data = data.get('services',{}).get('${svc}',{})
traces = svc_data.get('data',[])
print(len(traces))
" 2>/dev/null || echo "0")
    if [[ "$count" != "0" ]]; then
      trace_summary+="**${svc}:** ${count}  "
    fi
  done

  if [[ -n "$trace_summary" ]]; then
    printf "%s\n\n" "$trace_summary"
  fi

  if [[ -f "${REPORT_DIR}/traces.html" ]]; then
    printf "[Open trace viewer](./traces.html)\n\n"
  fi
fi

# --- Debug data links (collapsed) ----------------------------------------
printf "## Debug Data\n\n"

HAS_DEBUG=false
for item in "K8s events:${K8S_DIR}/events.txt" "Operator actions:${K8S_DIR}/operator-actions.json"; do
  label="${item%%:*}"
  fpath="${item#*:}"
  if [[ -f "$fpath" ]]; then
    HAS_DEBUG=true
    lines=$(wc -l < "$fpath" 2>/dev/null || echo "0")
    printf "<details><summary>%s (%s lines)</summary>\n\n" "$label" "$lines"
    printf '```\n'
    cat "$fpath"
    printf '```\n\n'
    printf "</details>\n\n"
  fi
done

# Service logs — collapsed, short.
for svc in "${SERVICES[@]}"; do
  LOG_FILE="${K8S_DIR}/logs-${svc}.txt"
  if [[ -f "$LOG_FILE" ]]; then
    HAS_DEBUG=true
    lines=$(wc -l < "$LOG_FILE" 2>/dev/null || echo "0")
    printf "<details><summary>%s logs (%s lines)</summary>\n\n" "$svc" "$lines"
    printf '```\n'
    tail -50 "$LOG_FILE"
    printf '```\n\n'
    printf "</details>\n\n"
  fi
done

if ! $HAS_DEBUG; then
  echo "_No debug data collected._"
  echo ""
fi

cat <<'EOF'
---

_End of report. Per-scenario details are in the linked scenario reports above._
EOF

exec >&3

ok "Report written to: ${REPORT_FILE}"
info "Size: $(wc -c < "${REPORT_FILE}") bytes"
